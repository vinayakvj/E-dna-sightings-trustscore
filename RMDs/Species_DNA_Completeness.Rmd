---
title: "Genus DNA Completeness"
author: "Nathan Reed (24110024)"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data and libraries

The problems in the data import all relate to column 22 ("neg_cont_type") which isn't used in our analysis but always good to check on import whether there were any issues.

```{r}
library(tidyverse)

# Load in the full dataset
data <- read_csv("../Data/all_voyages.csv")
problems(data)
```

Next subset the data to only the columns we need

```{r}
keep_columns <- c("ASV","sample","assay_name","Assay","count",
                  "genus","species","Species_In_LCA","X.ID",
                  "ASV_sequence","decimalLongitude","decimalLatitude")
data <- data[,keep_columns]
str(data)
```

## Explore assays

There's both "Assay" and "assay_name" in the supplied file. Looks like "Assay" is the better one to use.

```{r}
table(data$Assay, useNA="always")
table(data$assay_name, useNA="always")
```

```{r}
# Drop "assay_name" from the data
data <- select(data, -assay_name)

# Create a new variable this the string length of the ASV sequence
data$Assay_Length <- nchar(data$ASV_sequence)

# Re-order columns so related data is next to each other
data <- data %>% relocate(Assay, .after = 3)
data <- data %>% relocate(Assay_Length, .after = 4)
```

```{r}
str(data)
```

## eDNA Completeness Data Import

```{r}
# Load in DNA sequence counts for each region
NW_12S <- read_csv("../Data/Marine fish_Miya_12S_Northwest Australian Shelf.csv")
SW_12S <- read_csv("../Data/Marine fish_Miya_12S_Southwest Australian Shelf.csv")
WC_12S <- read_csv("../Data/Marine fish_Miya_12S_West Central Australian Shelf.csv")
```


```{r}
# Merge the datafiles and then check to see if the sequenced value is consistent across regions

# Select only the species and Sequenced columns, renaming Sequenced to match region
NW_12S <- NW_12S %>% select(Species, Sequenced) %>% rename(Northwest = Sequenced)
SW_12S <- SW_12S %>% select(Species, Sequenced) %>% rename(Southwest = Sequenced)
WC_12S <- WC_12S %>% select(Species, Sequenced) %>% rename(WestCentral = Sequenced)

# Join all three data frames by Species
merged_data <- NW_12S %>%
  full_join(SW_12S, by = "Species") %>%
  full_join(WC_12S, by = "Species")

# Reorder so Species is the first column
merged_12S_coverage <- merged_data %>% relocate(Species, .before = 1)

head(merged_12S_coverage)
```
```{r}
# Check to see whether there are any conflicts i.e. rows with both yes and no
conflicts <- merged_12S_coverage %>%
  rowwise() %>%
  filter(any(c_across(-Species) == "Yes", na.rm = TRUE) &
         any(c_across(-Species) == "No",  na.rm = TRUE)) %>%
  ungroup()

if (nrow(conflicts) == 0) {
  message("✅ No conflicts found: no species have both 'Yes' and 'No' across regions.")
} else {
  message("⚠️ Conflicts found! The following species have mixed Yes/No results:")
  print(conflicts)
}

```

```{r}
# Split the "Species" column as it actually contains Genus and Species together
merged_12S_coverage <- merged_12S_coverage %>%
  rename(genus_species = Species) %>%
  separate(genus_species, into = c("Genus", "Species"), sep = "_", remove=FALSE)
```
Checking the warning rows to see what's happened. Looks like the species name is duplicated in most cases and in a small number of others it's a subspecies. Searching for these sub species on Obis.org they're not classes as valid (i.e. https://obis.org/taxon/236453) so the parent species should be sufficient for our needs.

```{r}
problem_rows <- merged_12S_coverage %>%
  filter(grepl("_.*_", genus_species))

# Inspect them
print(problem_rows)
```
## Calculate species DNA coverage across all 3 regions

```{r}
# Create a yes/no record across all 3 regions
merged_12S_coverage <- merged_12S_coverage %>%
  rowwise() %>%
  mutate(
    AllRegions = if_else(
      any(c_across(c(Northwest, WestCentral, Southwest)) == "Yes", na.rm = TRUE),
      "Yes",
      "No"
    )
  ) %>%
  ungroup()

# Calculate DNA coverage per species
genus_summary <- merged_12S_coverage %>%
  group_by(Genus) %>%
  summarise(
    TotalSpecies = n(),
    YesCount = sum(AllRegions == "Yes"),
    ProportionYes = YesCount / TotalSpecies
  ) %>%
  arrange(Genus)

# View results
print(genus_summary)
```
## Apply species DNA coverage value back to the original dataframe

```{r}
# Create a new variable based on whether it's a 12 or 16 assay
data <- data %>%
  mutate(
    Assay_Type = case_when(
      Assay == "16SFish" ~ "16S",
      Assay %in% c("MarVer1", "MiFishE2", "MiFishU", "MiFishUE", "MiFishUE2") ~ "12S",
      TRUE ~ "Unknown"
    )
  )

# Move the new variable to be with the other assay variables
data <- data %>% relocate(Assay_Type, .after = 4)
```

```{r}
str(data)
```

```{r}
# Double check the numbers add up
data %>% count(Assay_Type)
data %>% count(Assay)
```

```{r}
### Update the dataframe with the genus DNA coverage for rows where a 12S DNA match was used

# Join genus_summary to main data on Genus
data <- data %>%
  left_join(
    genus_summary %>% select(Genus,ProportionYes),
    by = c("genus" = "Genus")
  )

# Rename and relocate ProportionYes column
data <- data %>% rename(Pct_GenusDNA_inDB = ProportionYes)
data <- data %>% relocate(Pct_GenusDNA_inDB, .after = 9)
```

```{r}
str(data)
```

# Export data back out to CSV for others to use

```{r}
write_csv(data, "../Data/data_with_genus_dna_pct.csv")
```

