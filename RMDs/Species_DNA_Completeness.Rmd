---
title: "Genus DNA Completeness"
author: "Nathan Reed (24110024)"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data and libraries

The problems in the data import all relate to column 22 ("neg_cont_type") which isn't used in our analysis but always good to check on import whether there were any issues.

```{r}
library(tidyverse)
library(httr)
library(jsonlite)
library(purrr)

# Load in the full dataset
data <- read_csv("../Data/all_voyages.csv")
problems(data)
```

Next subset the data to only the columns we need

```{r}
keep_columns <- c("ASV","sample","assay_name","Assay","count",
                  "genus","species","Species_In_LCA","X.ID",
                  "ASV_sequence","decimalLongitude","decimalLatitude")
data <- data[,keep_columns]
str(data)
```

## Explore assays

There's both "Assay" and "assay_name" in the supplied file. Looks like "Assay" is the better one to use.

```{r}
table(data$Assay, useNA="always")
table(data$assay_name, useNA="always")
```

```{r}
# Drop "assay_name" from the data
data <- select(data, -assay_name)

# Create a new variable which is the string length of the ASV sequence
data$Assay_Length <- nchar(data$ASV_sequence)

# Re-order columns so related data is next to each other
data <- data %>% relocate(Assay, .after = 3)
data <- data %>% relocate(Assay_Length, .after = 4)
```

```{r}
str(data)
```

## eDNA Completeness Data Import

```{r}
# Load in DNA sequence counts for each region
NW_12S <- read_csv("../Data/Marine fish_Miya_12S_Northwest Australian Shelf.csv")
SW_12S <- read_csv("../Data/Marine fish_Miya_12S_Southwest Australian Shelf.csv")
WC_12S <- read_csv("../Data/Marine fish_Miya_12S_West Central Australian Shelf.csv")

NW_16S <- read_csv("../Data/Marine fish_DiBattista_16S_Northwest Australian Shelf.csv")
SW_16S <- read_csv("../Data/Marine fish_DiBattista_16S_Southwest Australian Shelf.csv")
WC_16S <- read_csv("../Data/Marine fish_DiBattista_16S_West Central Australian Shelf.csv")
```

### Merge 12S

```{r}
# Merge the 12S datafiles and then check to see if the sequenced value is consistent across regions

# Select only the species and Sequenced columns, renaming Sequenced to match region
NW_12S <- NW_12S %>% select(Species, Sequenced) %>% rename(Northwest = Sequenced)
SW_12S <- SW_12S %>% select(Species, Sequenced) %>% rename(Southwest = Sequenced)
WC_12S <- WC_12S %>% select(Species, Sequenced) %>% rename(WestCentral = Sequenced)

# Join all three data frames by Species
merged_data_12S <- NW_12S %>%
  full_join(SW_12S, by = "Species") %>%
  full_join(WC_12S, by = "Species")

# Reorder so Species is the first column
merged_12S_coverage <- merged_data_12S %>% relocate(Species, .before = 1)

head(merged_12S_coverage)
```
```{r}
# Check to see whether there are any conflicts i.e. rows with both yes and no
conflicts <- merged_12S_coverage %>%
  rowwise() %>%
  filter(any(c_across(-Species) == "Yes", na.rm = TRUE) &
         any(c_across(-Species) == "No",  na.rm = TRUE)) %>%
  ungroup()

if (nrow(conflicts) == 0) {
  message("✅ No conflicts found: no species have both 'Yes' and 'No' across regions.")
} else {
  message("⚠️ Conflicts found! The following species have mixed Yes/No results:")
  print(conflicts)
}

```

```{r}
# Split the "Species" column as it actually contains Genus and Species together
merged_12S_coverage <- merged_12S_coverage %>%
  rename(genus_species = Species) %>%
  separate(genus_species, into = c("Genus", "Species"), sep = "_", remove=FALSE)
```

Checking the warning rows to see what's happened. Looks like the species name is duplicated in most cases and in a small number of others it's a subspecies. Searching for these sub species on Obis.org they're not classed as valid (i.e. https://obis.org/taxon/236453) so the parent species should be sufficient for our needs.

```{r}
problem_rows <- merged_12S_coverage %>%
  filter(grepl("_.*_", genus_species))

# Inspect them
print(problem_rows)
```

### Merge 16S

```{r}
# Merge the 16S datafiles and then check to see if the sequenced value is consistent across regions

# Select only the species and Sequenced columns, renaming Sequenced to match region
NW_16S <- NW_16S %>% select(Species, Sequenced) %>% rename(Northwest = Sequenced)
SW_16S <- SW_16S %>% select(Species, Sequenced) %>% rename(Southwest = Sequenced)
WC_16S <- WC_16S %>% select(Species, Sequenced) %>% rename(WestCentral = Sequenced)

# Join all three data frames by Species
merged_data_16S <- NW_16S %>%
  full_join(SW_16S, by = "Species") %>%
  full_join(WC_16S, by = "Species")

# Reorder so Species is the first column
merged_16S_coverage <- merged_data_16S %>% relocate(Species, .before = 1)

head(merged_16S_coverage)

# Check to see whether there are any conflicts i.e. rows with both yes and no
conflicts <- merged_12S_coverage %>%
  rowwise() %>%
  filter(any(c_across(-Species) == "Yes", na.rm = TRUE) &
         any(c_across(-Species) == "No",  na.rm = TRUE)) %>%
  ungroup()

if (nrow(conflicts) == 0) {
  message("✅ No conflicts found: no species have both 'Yes' and 'No' across regions.")
} else {
  message("⚠️ Conflicts found! The following species have mixed Yes/No results:")
  print(conflicts)
}

# Split the "Species" column as it actually contains Genus and Species together
merged_16S_coverage <- merged_16S_coverage %>%
  rename(genus_species = Species) %>%
  separate(genus_species, into = c("Genus", "Species"), sep = "_", remove=FALSE)

problem_rows <- merged_16S_coverage %>%
  filter(grepl("_.*_", genus_species))

# Inspect them
print(problem_rows)
```

## Calculate species DNA coverage across all 3 regions

### 12S

```{r}
# Create a yes/no record across all 3 regions
merged_12S_coverage <- merged_12S_coverage %>%
  rowwise() %>%
  mutate(
    AllRegions = if_else(
      any(c_across(c(Northwest, WestCentral, Southwest)) == "Yes", na.rm = TRUE),
      "Yes",
      "No"
    )
  ) %>%
  ungroup()

# Calculate DNA coverage per species
genus_summary_12S <- merged_12S_coverage %>%
  group_by(Genus) %>%
  summarise(
    TotalSpecies = n(),
    YesCount = sum(AllRegions == "Yes"),
    ProportionYes = YesCount / TotalSpecies
  ) %>%
  arrange(Genus)

# View results
print(genus_summary_12S)
```

### 16S

```{r}
# Create a yes/no record across all 3 regions
merged_16S_coverage <- merged_16S_coverage %>%
  rowwise() %>%
  mutate(
    AllRegions = if_else(
      any(c_across(c(Northwest, WestCentral, Southwest)) == "Yes", na.rm = TRUE),
      "Yes",
      "No"
    )
  ) %>%
  ungroup()

# Calculate DNA coverage per species
genus_summary_16S <- merged_16S_coverage %>%
  group_by(Genus) %>%
  summarise(
    TotalSpecies = n(),
    YesCount = sum(AllRegions == "Yes"),
    ProportionYes = YesCount / TotalSpecies
  ) %>%
  arrange(Genus)

# View results
print(genus_summary_16S)
```
## Merge the 16S and 12S dataframes to compare

```{r}
# Rename columns to avoid problems when merging
genus_summary_12S <- genus_summary_12S %>%
  rename(
    TotalSpecies_12S   = TotalSpecies,
    YesCount_12S       = YesCount,
    ProportionYes_12S  = ProportionYes
  )

genus_summary_16S <- genus_summary_16S %>%
  rename(
    TotalSpecies_16S   = TotalSpecies,
    YesCount_16S       = YesCount,
    ProportionYes_16S  = ProportionYes
  )

# Full join them by Genus so you get both sets of columns
genus_summary_combined <- full_join(
  genus_summary_12S,
  genus_summary_16S,
  by = "Genus"
)

# Reorder for readability
genus_summary_combined <- genus_summary_combined %>%
  select(
    Genus,
    TotalSpecies_12S, TotalSpecies_16S,
    YesCount_12S, YesCount_16S, 
    ProportionYes_12S, ProportionYes_16S
  )

genus_summary_combined
```

```{r}
# Check to see if the TotalSpecies value is consistent
genus_summary_combined %>% filter(TotalSpecies_12S != TotalSpecies_16S)
```


```{r}
# There's no mismatches so we can drop one of the columns and rename
genus_summary_combined <- genus_summary_combined %>% select(-TotalSpecies_16S) %>% rename(TotalSpecies = TotalSpecies_12S)
genus_summary_combined
```
```{r}
# See which species have the same vs. different data for 12S vs. 16S
(diff_counts <- count(genus_summary_combined %>% filter(YesCount_12S != YesCount_16S)))
(same_counts <- count(genus_summary_combined %>% filter(YesCount_12S == YesCount_16S)))
genus_summary_combined %>% filter(YesCount_12S != YesCount_16S)
genus_summary_combined %>% filter(YesCount_12S == YesCount_16S)
```


## Apply species DNA coverage value back to the original dataframe

```{r}
# Create a new variable based on whether it's a 12 or 16 assay
data <- data %>%
  mutate(
    Assay_Type = case_when(
      Assay == "16SFish" ~ "16S",
      Assay %in% c("MarVer1", "MiFishE2", "MiFishU", "MiFishUE", "MiFishUE2") ~ "12S",
      TRUE ~ "Unknown"
    )
  )

# Move the new variable to be with the other assay variables
data <- data %>% relocate(Assay_Type, .after = 4)
```

```{r}
str(data)
```

```{r}
# Double check the numbers add up
data %>% count(Assay_Type)
data %>% count(Assay)
```

```{r}
# Update the dataframe with the genus DNA coverage based on whether a 12S or 16S match was used
data <- data %>%
  left_join(
    genus_summary_combined,
    by = c("genus" = "Genus")
  ) %>%
  mutate(
    Pct_GenusDNA_inDB = case_when(
      Assay_Type == "12S" ~ ProportionYes_12S,
      Assay_Type == "16S" ~ ProportionYes_16S,
      TRUE ~ NA_real_
    )
  ) %>%
  relocate(Pct_GenusDNA_inDB, .after = 9)
```

```{r}
str(data)
```

## Export data back out to CSV for others to use

```{r}
write_csv(data, "../Data/data_with_genus_dna_pct.csv")
```

## Build a list of unique Genus / Species pairs in the datafile

```{r}
genus_species <- data[,"species"]
genus_species <- unique(genus_species)
genus_species$genus_species <- genus_species$species
genus_species <- genus_species %>% separate(genus_species, into = c("Genus", "Species"), sep = " ", remove=FALSE)
genus_species <- genus_species %>% filter(!is.na(Genus))
genus_species <- genus_species %>% filter(Genus != "dropped")
genus_species <- genus_species[,c("Genus","Species","genus_species")]
genus_species
```
